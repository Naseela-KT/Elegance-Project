<%-include("../user-layouts/header")%>
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
    <!-- Template CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>
    <header class="header-area header-style-5" style="box-shadow: rgba(0, 0, 0, 0.12) 0px 1px 3px, rgba(0, 0, 0, 0.24) 0px 1px 2px;">
        <div class="header-bottom sticky-bar sticky-white-bg">
            <div class="container">
                <div class="header-wrap header-space-between position-relative">
                    <div class="logo logo-width-1">
                        <a href="/"><img src="assets/imgs/theme/elegance.svg" alt="logo" height="50"></a>
                    </div>
                    <div class="main-menu main-menu-grow main-menu-padding-1 main-menu-lh-1 main-menu-mrg-1 hm3-menu-padding d-none d-lg-block hover-boder">
                        <nav>
                            <ul>
                                <li><a href="/">Home</a>
                                    
                                </li>
                                <li><a href="/allproducts">All</a>
                                    
                                </li>
                                <li class="position-static"><a href="/men">Men</a>
                                    
                                </li>
                                <li class="position-static"><a href="/women">Women</a>
                                   
                                </li>
                                
                                <li><a href="#">Pages <i class="fi-rs-angle-down"></i></a>
                                    <ul class="sub-menu">
                                        <li><a href="/about">About Us</a></li>
                                        <li><a href="/contact">Contact</a></li>
                                        <li><a href="/my/profile">My Account</a></li>
                                        
                                        
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    <div class="header-action-right">
                        <div class="search-style-1">
                            <form action="/search" method="post">
                                <input type="text" placeholder="Search for items…" name="searchCriteria">
                                <button type="submit" style="font-size: medium;">Search</button>
                            </form>
                        </div>
                        <div class="header-action-2">
                            <div class="header-action-icon-2">
                                <a href="/wishlist">
                                    <img class="svgInject" alt="Evara" src="assets/imgs/theme/icons/icon-heart.svg">
                                    <%if(userData[0].wishlist.length>0){%>
                                        <span class="pro-count blue" id="cart-quantity"><%=userData[0].wishlist.length%></span>
                                    <%}%>
                                </a>
                            </div>
    <div class="header-action-icon-2">
        <a class="mini-cart-icon" href="/cart">
            <img alt="Evara" src="assets/imgs/theme/icons/icon-cart.svg">
            <%if(quantity>0){%>
                <span class="pro-count blue"><%=quantity%></span>
            <%}%>
        </a>
    </div>
    <div class="header-action-icon-2">
        <ul>
        <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img alt="Evara" src="assets/imgs/theme/icons/user.png" width="25" height="25"></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                <a class="dropdown-item" href="my/profile"><i class="material-icons md-perm_identity"></i>My Account</a>
                <div class="dropdown-divider"></div>
               
                <!-- <form method="post" id="logoutForm" action="/logout" style="display: inline;">
                   <a class="dropdown-item text-danger" href=""><i class="material-icons md-exit_to_app" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();"></i>Logout</a>
                </form> -->
                <form id="logoutForm" method="post" action="/logout" style="display: inline;">
                    <button type="submit" class="dropdown-item text-light btn btn-light" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
                        <i class="material-icons md-exit_to_app"></i> Logout
                    </button>
                </form>
            </div>
        </li>
    </ul>
    </div>
    <div class="header-action-icon d-block d-lg-none">
        <div class="burger-icon">
            <span class="burger-icon-top"></span>
            <span class="burger-icon-mid"></span>
            <span class="burger-icon-bottom"></span>
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>
</header>
<%-include("../user-layouts/mobilenav")%>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 mb-sm-15">
                        <div class="toggle_info">
                            <span><i class="fi-rs-plus mr-10"></i><a href="#loginform" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Add address</a></span>
                        </div>
                        <div class="panel-collapse collapse login_form" id="loginform">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have shopped with us before, please enter your details below. If you are a new customer, please proceed to the Billing &amp; Shipping section.</p>
                                <form method="post" action="/checkout/add-address">
                                    <div class="row">
                                        <div class="form-group col-md-12">
                                            <label>Name <span class="required">*</span></label>
                                            <input required="" class="form-control square" name="adname" id="adname" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>Mobile<span class="required">*</span></label>
                                            <input required="" class="form-control square" name="admobile" id="admobile" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>House Name<span class="required">*</span></label>
                                            <input required="" class="form-control square" name="adhname" id="adhname" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>Area/Streat<span class="required">*</span></label>
                                            <input required="" class="form-control square" name="adarea" id="adarea" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>Town/City<span class="required">*</span></label>
                                            <input required="" class="form-control square" name="adcity" id="adcity" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>State<span class="required">*</span></label>
                                            <input required="" class="form-control square" name="adstate" id="adstate" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>Pincode <span class="required">*</span></label>
                                            <input required="" class="form-control square" name="adpin" id="adpin" type="text">
                                            <p class="error pt-1"></p>
                                        </div>
                                        
                                     <input type="text"  name="addressId" hidden>
                                        <div class="col-md-12 text-center">
                                            <button type="submit" class="btn btn-fill-out submit" name="submit" value="Submit" onclick="return checkEditAddressValidity()">Add</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a href="#coupon" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post" id="couponform">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code..." name="couponcode">
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn  btn-md" name="couponbutton" id="couponbutton">Apply Coupon</button>
                                    </div>
                                    <p class="text-danger font-sm" id="couponMessage"></p>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                  <!--place order form starts here -->
                <form method="post" action="/orderconfirm" id="placeorderform">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>Select a delivery address</h4>
                        </div>
                        
                        <div class="row">
                            <%if(userData[0].address.length==0){%>
                                <p style="color: red;">No address added!</p>
                            <%}else{%>
                                  
                           
                                <%for(let i=0;i<userData[0].address.length;i++){%>
                                    <div class="col-lg-6 mb-10">
                                        <div class="card mb-3 mb-lg-0">
                                            <div class="card-header d-flex">
                                                <input class="form-check-input mr-10 address-radio" type="radio" name="selectedAddress" data-address-id="<%= userData[0].address[i]._id %>" <%= userData[0].address[i].active ? 'checked' : '' %> />

                                        
                                                <h5 class="mb-0">Address <%=i+1%></h5>
                                            </div>
                                            <div class="card-body">
                                                <address><%=userData[0].address[i].name%>,<br><%=userData[0].address[i].housename%>,<%=userData[0].address[i].area%>,<br><%=userData[0].address[i].city%> <br><%=userData[0].address[i].state%>, <%=userData[0].address[i].pincode%></address>
                                                <p class="font-sm">Phone:<%=userData[0].address[i].mobile%></p>
                                                <div class="d-flex">
                                                    <a href="/editAddress?addressid=<%=userData[0].address[i]._id%>" type="button" class="btn-small btn mr-20">Edit</a>
                                                   
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                <%}%>
                            <%}%>
                            
                            
                        </div>
                            
                    </div>
                    
                    <div class="col-md-6">
                       
                        
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <%for(let i=0;i<productsInCart.length;i++){%>
                                            <tr>
                                                <td class="image product-thumbnail"><img src="admin/assets/imgs/products/<%=productsInCart[i].images[0].url%>" alt="#"></td>
                                                <td>
                                                    <h5><a href="shop-product-full.html"><%=productsInCart[i].productName%></a></h5> <span class="product-qty">x <%=quantityy[i]%></quantity></span>
                                                </td>
                                                <td>₹<%=price[i]%></td>
                                            </tr>
                                        <%}%>
                                        
                                       
                                        <tr>
                                            <th>SubTotal</th>
                                            <td class="product-subtotal" colspan="2">₹<span id="total"><%=total+catDiscount%></span></td>
                                        </tr>
                                        <tr>
                                            <th>Shipping</th>
                                            <td colspan="2"><em>Free Shipping</em></td>
                                        </tr>
                                        <tr>
                                            <th>Coupon Discount</th>
                                            <td colspan="2">₹<em id="couponDiscount">0</em></td>
                                        </tr>
                                        <tr>
                                            <th>Category Discount</th>
                                            <td colspan="2">₹<em id="categoryDiscount"><%=catDiscount%></em></td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td colspan="2" class="product-subtotal"><span class="font-xl text-brand fw-900">₹<span id="total2"><%=total%></span></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                           
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                            
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="cod">
                                        <label class="form-check-label" for="cod" data-bs-toggle="collapse" data-target="#checkPayment" aria-controls="checkPayment">Cash on Delivery</label>
                                        <div class="form-group collapse in" id="checkPayment">
                                            <p class="text-muted mt-5">Please send your cheque to Store Name, Store Street, Store Town, Store State / County, Store Postcode. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="razorpay">
                                        <label class="form-check-label" for="razorpay" data-bs-toggle="collapse" data-target="#Razorpay" aria-controls="Razorpay">Razorpay</label>
                                        <div class="form-group collapse in" id="Razorpay">
                                            <p class="text-muted mt-5">Pay via PayPal; you can pay with your credit card if you don't have a PayPal account.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                           
                            <button class="btn btn-fill-out btn-block mt-30" type="submit" >Place Order</button>
                        
                        </div>
                    </div>
                

                    </div>
                </form>
                </div>
            </div>
        </section>
    </main>
    <%-include("../user-layouts/footer.ejs")%>
    <!-- Preloader Start -->
    <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-3.6.0.min.js"></script>
    
    <!-- Vendor JS-->
    
    <script src="assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="assets/js/plugins/slick.js"></script>
    <script src="assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="assets/js/plugins/wow.js"></script>
    <script src="assets/js/plugins/jquery-ui.js"></script>
    <script src="assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="assets/js/plugins/magnific-popup.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/waypoints.js"></script>
    <script src="assets/js/plugins/counterup.js"></script>
    <script src="assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="assets/js/plugins/images-loaded.js"></script>
    <script src="assets/js/plugins/isotope.js"></script>
    <script src="assets/js/plugins/scrollup.js"></script>
    <script src="assets/js/plugins/jquery.vticker-min.js"></script>
    <!-- Template  JS -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/shop.js"></script>
    <script src="assets/js/cart.js"></script>
    <script src="assets/js/editAddressValidation.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function() {
        $("#placeorderform").submit(function(event) {
            event.preventDefault(); 

            const selectedPaymentOption = $('input[name="payment_option"]:checked').attr('id');
            const discount=parseInt($("#couponDiscount").text())
            const categorydiscount=parseInt($("#categoryDiscount").text())
            var formData = $(this).serialize();

            // Send an AJAX request to the server
            $.ajax({
                url: "/orderconfirm", 
                data: { formData: formData, paymentMethod: selectedPaymentOption,discount:discount,categorydiscount:categorydiscount},
                method: "POST",
                success: function(response) {
                    if (response.codsuccess) {
                        window.location.href='/orderconfirmation';
                    } else {
                        razorPayment(response); 
                    }

                },
                error: function(xhr, status, error) {
                    console.error(error);
                }
            });

            function verifyPayment(payment, order) {
                $.ajax({
                    url: '/verify-payment',
                    data: {
                        payment: payment,
                        order: order
                    },
                    method: 'POST',
                    success: function(response) {
                        console.log(response);
                        if (response.orderid) {
                            window.location.href = '/orderconfirmation';
                        }
                    },
                    error: function(error) {
                        if (error) {
                            window.location.href = '/errornotfound';
                        }
                    }
                });
            }

            function razorPayment(order) {
                console.log("order "+order);
                var options = {
                    "key": "rzp_test_jpPKjvl9THMRvf", 
                    "amount": order.amount,
                    "currency": "INR",
                    "name": "Elegance",
                    "description": "Test Transaction",
                    "order_id": order.id,
                    "handler": function(response) {
                        verifyPayment(JSON.stringify(response), JSON.stringify(order));
                    },
                    "prefill": {
                        "name": "Gaurav Kumar",
                        "email": "gaurav.kumar@example.com",
                        "contact": "9000090000"
                    },
                    "notes": {
                        "address": "Razorpay Corporate Office"
                    }
                   }
                

                var rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', function(response){
                    console.error(response.error.code);
                    console.error(response.error.description);
                    console.error(response.error.source);
                    console.error(response.error.step);
                    console.error(response.error.reason);
                    console.error(response.error.metadata.order_id);
                    console.error(response.error.metadata.payment_id);
                });
                rzp1.open();
            }


           
        });

    document.getElementById('couponbutton').addEventListener('click', function (event) {
    event.preventDefault();
    const couponCode = $("input[name='couponcode']").val();
    const total=parseInt($("#total").text())
    $.ajax({
        url: '/applycoupon',
        method: 'POST',
        data: JSON.stringify({ couponcode: couponCode,total:total}),
        contentType: 'application/json',
        dataType: 'json',
        success: (response) => {
            if (response.message) {
                $("#couponMessage").text(response.message);
            }else if (response.discount) {
                $("#total2").text(parseInt($("#total2").text()) - response.discount);
                Swal.fire({
                icon: 'success',
                title: "Success",
                html: "Coupon applied Successfully",
                confirmButtonText: "Ok"
            });
            $("#couponMessage").text("");
            $("input[name='couponcode']").val("")
            $("#couponDiscount").text(response.discount)
        }
        },
        error: (xhr, status, error) => {
            console.error(error);
        }
    });
});

    });
</script>

</body>


<!-- Mirrored from wp.alithemes.com/html/evara/evara-frontend/shop-checkout.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:26:06 GMT -->
</html>